angular.module('angularApp', ['ui.router','oc.lazyLoad','chart.js'])
.constant('config', {
    apibase:'http://35.200.128.175:3000'
})
.run(['$rootScope','$location', 'Auth',
	 function ($rootScope, $location, Auth) {
    	$rootScope.$on('$locationChangeStart', function (event) {
          if (!Auth.isLoggedIn()) {
            console.log('DENY');
            //event.preventDefault();
            $("#essential").hide();
            if($location.path()=='/signup')
                $location.path('/signup');
            else
            $location.path('/login');
        }
        else {
            console.log('ALLOW');
            $("#essential").show();
            if ($location.path()=='/login') {   
            $location.path('/Dashboard');
            }
        }
        $rootScope.$on('$locationChangeSuccess', function (event) {
            var path=$location.path();
            $rootScope.path=path.slice(1,$location.path().length);
        });

    });
}])
    
    .config(['$httpProvider','$locationProvider','$stateProvider','$ocLazyLoadProvider', function($httpProvider,$locationProvider,$stateProvider,$ocLazyLoadProvider) {
        $locationProvider.html5Mode(true);
         //Enable cross domain calls
    $httpProvider.defaults.useXDomain = true;
    delete $httpProvider.defaults.headers.common['X-Requested-With'];
    $httpProvider.defaults.withCredentials = true;
        $stateProvider
            .state('login', {
                url         : '/login',
                templateUrl : 'public/templates/login.html',
                controller  : 'loginCtrl'
            })
            .state('logout', {
                url         : '/logout',
                controller  : 'logoutCtrl'
            })
            .state('signup', {
                url         : '/signup',
                templateUrl : 'public/templates/signup.html',
                resolve: { loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                 return $ocLazyLoad.load('build/scripts/controller/signupCtrl.js');
                        }]
                      } 
            })    
            .state('/', {
                url         : '/Dashboard',
                templateUrl : 'public/templates/dashboard/dashboard.html',
                 resolve: { // Any property in resolve should return a promise and is executed before the view is loaded
                        loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                          // you can lazy load files for an existing module
                                 return $ocLazyLoad.load('build/scripts/controller/dashboardCtrl.js');
                        }]
                      }
            })
            .state('Dashboard', {
                url         : '/Dashboard',
                templateUrl : 'public/templates/dashboard/dashboard.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/dashboardCtrl.js');
                        }]}
            })        
            .state('Dealer_Equipments', {
                url         : '/Dealer_Equipments',
                templateUrl : 'public/templates/equipments/equipments.html',
                resolve: {
                        loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                          // you can lazy load files for an existing module
                                 return $ocLazyLoad.load('build/scripts/controller/equipments/dealer_equipmentsCtrl.js');
                        }]
                      }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
            })
            .state('Add_Equipment', {
                url         : '/Add_Equipment',
                templateUrl : 'public/templates/equipments/add_equip.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/equipments/add_equipCtrl.js');
                        }]}
            })
            .state('DRM', {
                url         : '/DRM',
                templateUrl : 'public/templates/drm/drm.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/drm/drmCtrl.js');
                        }]}
            })
            .state('Add_Lead', {
                url         : '/Add_Lead',
                templateUrl : 'public/templates/drm/add_lead.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/drm/addleadCtrl.js');
                        }]}
            })
            .state('carprofile', {
                url         : '/carprofile/:id',
                templateUrl : 'public/templates/carprofile.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/carCtrl.js');
                        }]}
            })
            .state('profile', {
                url         : '/profile',
                templateUrl : 'public/templates/profile/profile.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/profileCtrl.js');
                        }]}
            })
            .state('auction', {
                url         : '/auction',
                templateUrl : 'public/templates/auction/auction.html',
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/auction/auctionCtrl.js');
                        }]}
            })
            .state('upcommingauction', {
                url         : '/upauction',
                templateUrl : 'public/templates/auction/upcommingauction.html', 
                resolve: {  loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                                return $ocLazyLoad.load('build/scripts/controller/auction/upauctionCtrl.js');
                        }]}
            })            
    }]);
angular.module('angularApp')

    .controller('loginCtrl', ['config','$location','$scope','$rootScope','$http', 'Auth', function (config,$location,$scope,$rootScope,$http, Auth) {

	  $scope.login = function () {
	    // Ask to the server, do your job and THEN set the user
        $http({
        url: config.apibase+'/login',
        method: "POST",
        data:{'mobile':$scope.mobile,'password':$scope.password },
    	})
        .then(function (resp) { 
        	console.log(resp);
		    if (resp.data.msg=="Hello, Welcome") 
		    	{	
		    		Auth.setUser(resp.data.name);
		    		Auth.setId(resp.data.id);
			    	$("#essential").show();
			    	$scope.menu =[{"name":"Home","icon":"home","href":"Home"}
						      ,{"name":"Dashboard","icon":"dashboard","href":"Dashboard"}
						      ,{"name":"My Equipments","icon":"upload","href":"Dealer_Equipments"}
						      ,{"name":"Dealer Management","icon":"cogs","href":"DRM"}
						      ,{"name":"Profile","icon":"user","href":"profile"}
						      ,{"name":"Auctions","icon":"gavel","href":"auction"}
						      ,{"name":"Allocations","icon":"get-pocket","href":"allocation"}
						      ,{"name":"Logout","icon":"sign-out","href":"logout"}];
			    	$location.path("/Dashboard");
		    	}
		    else {
		     	alert("Invalid Login");
		     } 
		});
	}
}])

.controller('logoutCtrl', ['config', '$scope','$http',  function (config,$scope,$http) {
		$http.get(config.apibase+"/logout")
		.then(function (resp) {
			console.log(resp);
			localStorage.removeItem("auto_user");
			localStorage.removeItem("id");
		});
   }]);
angular.module('angularApp')
.controller('mainController', ['$scope', 'Auth', '$location', function ($scope, Auth, $location) {
$scope.hide=function(){  $('sidebar, topbar').hide();  };
$scope.show=function(){  $('sidebar, topbar').show();  };

$scope.$watch(Auth.isLoggedIn, function (value, oldValue) {    
    if($location.path()!='/login')
    	$("#essential").show();
    else $("#essential").hide();

    if(!value && oldValue) {
      console.log("Disconnect");
      $location.path('/login');
    }

    if(value) {
      console.log("Connect");
      //Do something when the user is connected
    }
  }, true);


 }]);
angular.module('angularApp')
	.factory('Auth', function(){
	var user;
	var path;
	return{
	    setUser : function(aUser){
	        localStorage.setItem("auto_user",aUser);

	    },
	    isLoggedIn : function(){
	    	user=localStorage.getItem("auto_user");
	        return(user)? user : false;
	    },
	    getUser :function(){
	    	return user;
	    },
	    setId : function(id){
	        localStorage.setItem("id",id);
	    },
	    getId : function(){
	        return localStorage.getItem('id');
	    }	
	  }
	});
/**
 * Created by semianchuk on 11.10.16.
 */
angular.module('angularApp')
    .provider('mainProvider',[ function () {
        var privateVariable = 'mainProvider';

        return {
            $get: function() {
                function getPrivate() {
                    return privateVariable;
                }
                return {
                    getPrivate: getPrivate
                };
            }
        };
    }]);
/**
 * Created by semianchuk on 08.10.16.
 */
angular.module('angularApp')
    .service('mainService', [ function () {
        var thisIsPrivate = "mainService";
        this.getPrivate = function() {
            return thisIsPrivate;
        };
        var script_path = "build/scripts/";
        this.getPath = function() {
            return script_path;
        };
        var css_path = "build/scripts/";
        this.getcssPath = function() {
            return css_path;
        };
    }]);
angular.module('angularApp')
.directive('sidebar', function() {
  return {
    restrict: 'E',
    scope:false,
    templateUrl: 'public/templates/sidebar.html',
    link: function(scope) {
      scope.menu =[
      {"name":"Dashboard","icon":"dashboard","href":"Dashboard"}
      ,{"name":"My Equipments","icon":"upload","href":"Dealer_Equipments"}
      ,{"name":"Dealer Management","icon":"cogs","href":"DRM"}
      ,{"name":"Profile","icon":"user","href":"profile"}
      ,{"name":"Auctions","icon":"gavel","href":"auction"}
      ,{"name":"Allocations","icon":"get-pocket","href":"allocation"}
      ,{"name":"Logout","icon":"sign-out","href":"logout"}];
    
    scope.user =[
      {"name":"Dashboard","icon":"dashboard","href":"Dashboard"}
      ,{"name":"My Equipments","icon":"upload","href":"Dealer_Equipments"}
      ,{"name":"Dealer Management","icon":"cogs","href":"DRM"}
      ,{"name":"Profile","icon":"user","href":"profile"}
      ,{"name":"Auctions","icon":"gavel","href":"auction"}
      ,{"name":"Allocations","icon":"get-pocket","href":"allocation"}
      ,{"name":"Logout","icon":"sign-out","href":"logout"}];
    }
  };
})
.directive('topbar', function(Auth) {
  return {
    restrict: 'E',
    scope: false,
    templateUrl: 'public/templates/topbar.html',
    link: function(scope,) {     
        scope.$watch(function() {
            scope.username=Auth.getUser();
        });
        scope.search=function(){
            scope.search_result=['one','two','three','four'];
        } 
    }
  };
})
