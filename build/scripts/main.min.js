angular.module('angularApp', ['ui.router','oc.lazyLoad'])
angular.module('angularApp').run(['$rootScope', '$location', 'Auth', function ($rootScope, $location, Auth) {
    $rootScope.$on('$routeChangeStart', function (event) {

        if (!Auth.isLoggedIn()) {
            console.log('DENY');
            event.preventDefault();
            $location.path('/login');
        }
        else {
            console.log('ALLOW');
            $location.path('/');
        }
    });
}]);

/**
 * Created by semianchuk on 08.10.16.
 */
angular.module('angularApp')
    .config(['$locationProvider','$stateProvider','$ocLazyLoadProvider', function($locationProvider,$stateProvider,$ocLazyLoadProvider) {
        $locationProvider.html5Mode(true);

        $stateProvider
            .state('login', {
                url         : '/login',
                templateUrl : 'public/templates/login.html',
                controller  : 'loginCtrl'
            })    
            .state('/', {
                url         : '/Dashboard',
                templateUrl : 'public/templates/dashboard/dashboard.html',
                 resolve: { // Any property in resolve should return a promise and is executed before the view is loaded
                        loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                          // you can lazy load files for an existing module
                                 return $ocLazyLoad.load('build/scripts/controller/dashboardCtrl.js');
                        }]
                      }
            })
            .state('Dashboard', {
                url         : '/Dashboard',
                templateUrl : 'public/templates/dashboard/dashboard.html',
                 resolve: { // Any property in resolve should return a promise and is executed before the view is loaded
                        loadMyCtrl: ['$ocLazyLoad', function($ocLazyLoad) {
                          // you can lazy load files for an existing module
                                 return $ocLazyLoad.load('build/scripts/controller/dashboardCtrl.js');
                        }]
                      }
            })        
            .state('contact', {
                url         : '/contact',
                templateUrl : 'public/templates/contact.html',
                controller  : 'contactController'
            })            
            .state('component', {
                url         : '/component',
                templateUrl : 'public/templates/component.html'
            })
            .state('module', {
                url         : '/module',
                templateUrl : 'public/templates/newmodule.html'
            })
            .state('provider', {
                url         : '/provider',
                templateUrl : 'public/templates/provider.html',
                controller  : 'mainController'
            })
            
    }]);
angular.module('angularApp')

    .controller('loginCtrl', [ '$scope','$http', 'Auth', function ($scope,$http, Auth) {
      $scope.show=false;
	  //submit
	  $scope.login = function () {
	    // Ask to the server, do your job and THEN set the user

        $http({
        url: 'http://localhost:8080/login',
        method: "POST",
        data: $.param({"mobile":$scope.mobile,"password":$scope.password}),
    	headers: {'Content-Type': 'application/x-www-form-urlencoded'}
    	})
        .then(function (resp) { 
		    if (resp.data=="Welcome") 
		    	{$scope.show=true;
		    	location.href="/Dashboard";} 
		    	console.log(resp);
		});

	    Auth.setUser("user"); //Update the state of the user in the app
	}
	$scope.logout = function () {
		$http.get("http://localhost:8080/profile/1")
		.then(function (resp) {
			console.log(resp);
		});
	}

}]);
angular.module('angularApp')
    .controller('mainController', ['$scope', 'Auth', '$location', function ($scope, Auth, $location) {

 	 $scope.$watch(Auth.isLoggedIn, function (value, oldValue) {

    if(!value && oldValue) {
      console.log("Disconnect");
      $location.path('/login');
    }

    if(value) {
      console.log("Connect");
      //Do something when the user is connected
    }

  }, true);
 }]);
angular.module('angularApp')
	.factory('Auth', function(){
	var user;

	return{
	    setUser : function(aUser){
	        user = aUser;
	    },
	    isLoggedIn : function(){
	        return(user)? user : false;
	    }
	  }
	});
/**
 * Created by semianchuk on 11.10.16.
 */
angular.module('angularApp')
    .provider('mainProvider',[ function () {
        var privateVariable = 'mainProvider';

        return {
            $get: function() {
                function getPrivate() {
                    return privateVariable;
                }
                return {
                    getPrivate: getPrivate
                };
            }
        };
    }]);
/**
 * Created by semianchuk on 08.10.16.
 */
angular.module('angularApp')
    .service('mainService', [ function () {
        var thisIsPrivate = "mainService";
        this.getPrivate = function() {
            return thisIsPrivate;
        };
        var script_path = "build/scripts/";
        this.getPath = function() {
            return script_path;
        };
        var css_path = "build/scripts/";
        this.getcssPath = function() {
            return css_path;
        };
    }]);
angular.module('angularApp')
.directive('sidebar', function() {
  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'public/templates/sidebar.html',
    link: function(scope) {
      scope.menu =[{"name":"Home","icon":"home","href":"Home"}
      ,{"name":"Dashboard","icon":"dashboard","href":"Dashboard"}
      ,{"name":"Dealer Management","icon":"cogs","href":"dealer_management"}
      ,{"name":"Upload Listing","icon":"upload","href":"upload_listing"}];
    }
  };
})
.directive('topbar', function() {
  return {
    restrict: 'E',
    scope: {},
    templateUrl: 'public/templates/topbar.html',
    link: function(scope) {
      
    }
  };
});